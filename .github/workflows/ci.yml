# .github/workflows/ci.yml
name: CI

on:
  pull_request:
  push:
    branches: [ main ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true  # æ–°çš„è·‘èµ·ä¾†æœƒå–æ¶ˆèˆŠçš„

jobs:
  test:
    runs-on: ubuntu-latest
    container: mcr.microsoft.com/playwright:v1.49.0-noble   # ä¹‹å¾Œå¯æ”¹æˆè‡ªæœ‰æ˜ åƒ
    timeout-minutes: 20

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'                    # éœ€æœ‰ package-lock.json / yarn.lock æ‰æœƒç”Ÿæ•ˆ
          cache-dependency-path: 'package-lock.json'

      - name: ğŸ”§ Install dependencies
        run: npm ci

      - name: ğŸ” Lint (optional)
        run: npm run lint --if-present

      # è‹¥ä½ ä¸æ˜¯è·‘åœ¨ Playwright å®˜æ–¹å®¹å™¨ã€è€Œæ˜¯ ubuntu ä¸»æ©Ÿï¼Œå¯æ”¹ç”¨ï¼š
      # - run: npx playwright install --with-deps
      # Playwright CI æŒ‡å—è©³è¦‹å®˜æ–¹æ–‡ä»¶
      # https://playwright.dev/docs/ci

      - name: ğŸ” Setup and login
        env:
          BASE_URL: ${{ vars.BASE_URL || 'https://erpline.aoacloud.com.tw/' }}
          COMPANY_CODE: ${{ vars.COMPANY_CODE || 'CYBERBIZ' }}
          AOA_USERNAME: ${{ secrets.AOA_USERNAME }}
          AOA_PASSWORD: ${{ secrets.AOA_PASSWORD }}
          AOA_LAT: ${{ vars.AOA_LAT || '25.080869' }}
          AOA_LON: ${{ vars.AOA_LON || '121.569862' }}
          TZ: ${{ vars.TZ || 'Asia/Taipei' }}
          LOCALE: ${{ vars.LOCALE || 'zh-TW' }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          LINE_CHANNEL_ACCESS_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
          LINE_USER_ID: ${{ secrets.LINE_USER_ID }}
          LOG_LEVEL: ${{ vars.LOG_LEVEL || 'INFO' }}
        run: |
          echo "ğŸ” é–‹å§‹ç’°å¢ƒæª¢æŸ¥å’Œç™»å…¥è¨­ç½®..."
          npx playwright test --project=setup --workers=1

      - name: ğŸ“¢ Run notify tests (with retry)
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 15
          max_attempts: 3
          retry_wait_seconds: 60
          retry_on: error
          command: |
            echo "ğŸ“¢ é–‹å§‹åŸ·è¡Œé€šçŸ¥æ¸¬è©¦..."
            echo "â° åŸ·è¡Œæ™‚é–“: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            npx playwright test --project=notify --workers=1 --trace on
        env:
          BASE_URL: ${{ vars.BASE_URL || 'https://erpline.aoacloud.com.tw/' }}
          COMPANY_CODE: ${{ vars.COMPANY_CODE || 'CYBERBIZ' }}
          AOA_USERNAME: ${{ secrets.AOA_USERNAME }}
          AOA_PASSWORD: ${{ secrets.AOA_PASSWORD }}
          AOA_LAT: ${{ vars.AOA_LAT || '25.080869' }}
          AOA_LON: ${{ vars.AOA_LON || '121.569862' }}
          TZ: ${{ vars.TZ || 'Asia/Taipei' }}
          LOCALE: ${{ vars.LOCALE || 'zh-TW' }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          LINE_CHANNEL_ACCESS_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
          LINE_USER_ID: ${{ secrets.LINE_USER_ID }}
          LOG_LEVEL: ${{ vars.LOG_LEVEL || 'INFO' }}
      
      - name: ğŸ¯ Run chromium-smoke tests (with retry)
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 15
          max_attempts: 3
          retry_wait_seconds: 60
          retry_on: error
          command: |
            echo "ğŸ¯ é–‹å§‹åŸ·è¡Œ smoke æ¸¬è©¦..."
            echo "â° åŸ·è¡Œæ™‚é–“: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            npx playwright test --project=chromium-smoke --workers=1 --trace on
        env:
          BASE_URL: ${{ vars.BASE_URL || 'https://erpline.aoacloud.com.tw/' }}
          COMPANY_CODE: ${{ vars.COMPANY_CODE || 'CYBERBIZ' }}
          AOA_USERNAME: ${{ secrets.AOA_USERNAME }}
          AOA_PASSWORD: ${{ secrets.AOA_PASSWORD }}
          AOA_LAT: ${{ vars.AOA_LAT || '25.080869' }}
          AOA_LON: ${{ vars.AOA_LON || '121.569862' }}
          TZ: ${{ vars.TZ || 'Asia/Taipei' }}
          LOCALE: ${{ vars.LOCALE || 'zh-TW' }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          LINE_CHANNEL_ACCESS_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
          LINE_USER_ID: ${{ secrets.LINE_USER_ID }}
          LOG_LEVEL: ${{ vars.LOG_LEVEL || 'INFO' }}

      - name: ğŸ“¤ Upload test results (if failed)
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: test-results-${{ github.run_number }}
          path: |
            test-results/
            playwright-report/
          retention-days: 7

      - name: ğŸ“Š Upload traces (if failed)
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: traces-${{ github.run_number }}
          path: test-results/**/*.zip
          retention-days: 3

      - name: ğŸš¨ Notify on failure
        if: failure()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -n "$DISCORD_WEBHOOK_URL" ]; then
            curl -H "Content-Type: application/json" \
                 -d "{\"content\":\"âŒ **CI æ¸¬è©¦å¤±æ•—**\nğŸ”— æŸ¥çœ‹è©³æƒ…: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\"}" \
                 "$DISCORD_WEBHOOK_URL" || echo "Discord é€šçŸ¥ç™¼é€å¤±æ•—"
          fi