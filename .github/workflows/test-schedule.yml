name: 測試排程 - 自動打卡

on:
  # schedule:
  #   # 每5分鐘執行一次（測試階段）
  #   - cron: '*/5 * * * *'
  
  # 允許手動觸發（方便調試）
  workflow_dispatch:
    inputs:
      test_type:
        description: '測試類型'
        required: false
        default: 'click'
        type: choice
        options:
          - smoke
          - click
      action_type:
        description: '動作類型'
        required: false
        default: 'checkin'
        type: choice
        options:
          - checkin
          - checkout
      log_level:
        description: '日誌等級'
        required: false
        default: 'DEBUG'
        type: choice
        options:
          - DEBUG
          - INFO
          - WARN
          - ERROR

jobs:
  test-punch:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v4

      - name: 📦 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: 🔧 Install dependencies
        run: npm ci

      - name: 🎭 Install Playwright browsers
        run: npx playwright install chromium

      - name: 🔤 Install Chinese fonts
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-noto-cjk fonts-wqy-zenhei

      - name: 🔍 Environment check and login setup
        env:
          BASE_URL: ${{ vars.BASE_URL || 'https://erpline.aoacloud.com.tw/' }}
          COMPANY_CODE: ${{ vars.COMPANY_CODE ||'CYBERBIZ'}}
          AOA_USERNAME: ${{ secrets.AOA_USERNAME }}
          AOA_PASSWORD: ${{ secrets.AOA_PASSWORD }}
          AOA_LAT: ${{ vars.AOA_LAT || '25.080869' }}
          AOA_LON: ${{ vars.AOA_LON || '121.569862' }}
          TZ: ${{ vars.TZ || 'Asia/Taipei' }}
          LOCALE: ${{ vars.LOCALE || 'zh-TW' }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          LINE_CHANNEL_ACCESS_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
          LINE_USER_ID: ${{ secrets.LINE_USER_ID }}
          LOG_LEVEL: ${{ github.event.inputs.log_level || 'INFO' }}
        run: |
          echo "🔍 開始環境檢查和登入設置..."
          npx playwright test --project=setup --workers=1

      - name: 🎯 執行真實打卡操作（含重試機制）
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 15
          max_attempts: 3
          retry_wait_seconds: 60
          retry_on: error
          command: |
            echo "🎯 開始執行真實打卡操作..."
            echo "⏰ 執行時間: $(date -u '+%Y-%m-%d %H:%M:%S UTC') ($(TZ='Asia/Taipei' date '+%Y-%m-%d %H:%M:%S %Z'))"
            echo "📋 測試類型: ${{ github.event.inputs.action_type || 'checkin' }} - ${{ github.event.inputs.test_type || 'click' }}"
            TEST_FILE="tests/check/${{ github.event.inputs.action_type || 'checkin' }}.${{ github.event.inputs.test_type || 'click' }}.spec.ts"
            PROJECT_NAME="chromium-${{ github.event.inputs.test_type || 'click' }}"
            echo "🎭 執行測試文件: $TEST_FILE"
            npx playwright test "$TEST_FILE" --project="$PROJECT_NAME" --workers=1 --trace on
        env:
          BASE_URL: ${{ vars.BASE_URL || 'https://erpline.aoacloud.com.tw/' }}
          COMPANY_CODE: ${{ vars.COMPANY_CODE ||'CYBERBIZ'}}
          AOA_USERNAME: ${{ secrets.AOA_USERNAME }}
          AOA_PASSWORD: ${{ secrets.AOA_PASSWORD }}
          AOA_LAT: ${{ vars.AOA_LAT || '25.080869' }}
          AOA_LON: ${{ vars.AOA_LON || '121.569862' }}
          TZ: ${{ vars.TZ || 'Asia/Taipei' }}
          LOCALE: ${{ vars.LOCALE || 'zh-TW' }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          LINE_CHANNEL_ACCESS_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
          LINE_USER_ID: ${{ secrets.LINE_USER_ID }}
          LOG_LEVEL: ${{ github.event.inputs.log_level || 'INFO' }}

      - name: 📤 Upload test results (if failed)
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: test-results-${{ github.run_number }}
          path: |
            test-results/
            playwright-report/
          retention-days: 7

      - name: 📊 Upload traces (if failed)
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: traces-${{ github.run_number }}
          path: test-results/**/*.zip
          retention-days: 3

      - name: 🚨 Notify on failure
        if: failure()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -n "$DISCORD_WEBHOOK_URL" ]; then
            curl -H "Content-Type: application/json" \
                 -d "{\"content\":\"❌ **自動打卡測試失敗**\n⏰ 時間: $(TZ='Asia/Taipei' date '+%Y-%m-%d %H:%M:%S %Z')\n🔗 查看詳情: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\"}" \
                 "$DISCORD_WEBHOOK_URL" || echo "Discord 通知發送失敗"
          fi