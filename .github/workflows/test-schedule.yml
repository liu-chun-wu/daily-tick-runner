name: æ¸¬è©¦æ’ç¨‹ - è‡ªå‹•æ‰“å¡

on:
  # schedule:
  #   # æ¯5åˆ†é˜åŸ·è¡Œä¸€æ¬¡ï¼ˆæ¸¬è©¦éšæ®µï¼‰
  #   - cron: '*/5 * * * *'
  
  # å…è¨±æ‰‹å‹•è§¸ç™¼ï¼ˆæ–¹ä¾¿èª¿è©¦ï¼‰
  workflow_dispatch:
    inputs:
      test_type:
        description: 'æ¸¬è©¦é¡å‹'
        required: false
        default: 'click'
        type: choice
        options:
          - smoke
          - click
      action_type:
        description: 'å‹•ä½œé¡å‹'
        required: false
        default: 'checkin'
        type: choice
        options:
          - checkin
          - checkout
      log_level:
        description: 'æ—¥èªŒç­‰ç´š'
        required: false
        default: 'DEBUG'
        type: choice
        options:
          - DEBUG
          - INFO
          - WARN
          - ERROR

jobs:
  test-punch:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ”§ Install dependencies
        run: npm ci

      - name: ğŸ­ Install Playwright browsers
        run: npx playwright install chromium

      - name: ğŸ”¤ Install Chinese fonts
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-noto-cjk fonts-wqy-zenhei

      - name: ğŸ” Environment check and login setup
        env:
          BASE_URL: ${{ vars.BASE_URL || 'https://erpline.aoacloud.com.tw/' }}
          COMPANY_CODE: ${{ vars.COMPANY_CODE ||'CYBERBIZ'}}
          AOA_USERNAME: ${{ secrets.AOA_USERNAME }}
          AOA_PASSWORD: ${{ secrets.AOA_PASSWORD }}
          AOA_LAT: ${{ vars.AOA_LAT || '25.080869' }}
          AOA_LON: ${{ vars.AOA_LON || '121.569862' }}
          TZ: ${{ vars.TZ || 'Asia/Taipei' }}
          LOCALE: ${{ vars.LOCALE || 'zh-TW' }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          LINE_CHANNEL_ACCESS_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
          LINE_USER_ID: ${{ secrets.LINE_USER_ID }}
          LOG_LEVEL: ${{ github.event.inputs.log_level || 'INFO' }}
        run: |
          echo "ğŸ” é–‹å§‹ç’°å¢ƒæª¢æŸ¥å’Œç™»å…¥è¨­ç½®..."
          npx playwright test --project=setup --workers=1

      - name: ğŸ¯ åŸ·è¡ŒçœŸå¯¦æ‰“å¡æ“ä½œï¼ˆå«é‡è©¦æ©Ÿåˆ¶ï¼‰
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 15
          max_attempts: 3
          retry_wait_seconds: 60
          retry_on: error
          command: |
            echo "ğŸ¯ é–‹å§‹åŸ·è¡ŒçœŸå¯¦æ‰“å¡æ“ä½œ..."
            echo "â° åŸ·è¡Œæ™‚é–“: $(date -u '+%Y-%m-%d %H:%M:%S UTC') ($(TZ='Asia/Taipei' date '+%Y-%m-%d %H:%M:%S %Z'))"
            echo "ğŸ“‹ æ¸¬è©¦é¡å‹: ${{ github.event.inputs.action_type || 'checkin' }} - ${{ github.event.inputs.test_type || 'click' }}"
            TEST_FILE="tests/check/${{ github.event.inputs.action_type || 'checkin' }}.${{ github.event.inputs.test_type || 'click' }}.spec.ts"
            PROJECT_NAME="chromium-${{ github.event.inputs.test_type || 'click' }}"
            echo "ğŸ­ åŸ·è¡Œæ¸¬è©¦æ–‡ä»¶: $TEST_FILE"
            npx playwright test "$TEST_FILE" --project="$PROJECT_NAME" --workers=1 --trace on
        env:
          BASE_URL: ${{ vars.BASE_URL || 'https://erpline.aoacloud.com.tw/' }}
          COMPANY_CODE: ${{ vars.COMPANY_CODE ||'CYBERBIZ'}}
          AOA_USERNAME: ${{ secrets.AOA_USERNAME }}
          AOA_PASSWORD: ${{ secrets.AOA_PASSWORD }}
          AOA_LAT: ${{ vars.AOA_LAT || '25.080869' }}
          AOA_LON: ${{ vars.AOA_LON || '121.569862' }}
          TZ: ${{ vars.TZ || 'Asia/Taipei' }}
          LOCALE: ${{ vars.LOCALE || 'zh-TW' }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          LINE_CHANNEL_ACCESS_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
          LINE_USER_ID: ${{ secrets.LINE_USER_ID }}
          LOG_LEVEL: ${{ github.event.inputs.log_level || 'INFO' }}

      - name: ğŸ“¤ Upload test results (if failed)
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: test-results-${{ github.run_number }}
          path: |
            test-results/
            playwright-report/
          retention-days: 7

      - name: ğŸ“Š Upload traces (if failed)
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: traces-${{ github.run_number }}
          path: test-results/**/*.zip
          retention-days: 3

      - name: ğŸš¨ Notify on failure
        if: failure()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -n "$DISCORD_WEBHOOK_URL" ]; then
            curl -H "Content-Type: application/json" \
                 -d "{\"content\":\"âŒ **è‡ªå‹•æ‰“å¡æ¸¬è©¦å¤±æ•—**\nâ° æ™‚é–“: $(TZ='Asia/Taipei' date '+%Y-%m-%d %H:%M:%S %Z')\nğŸ”— æŸ¥çœ‹è©³æƒ…: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\"}" \
                 "$DISCORD_WEBHOOK_URL" || echo "Discord é€šçŸ¥ç™¼é€å¤±æ•—"
          fi