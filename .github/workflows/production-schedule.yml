name: æ­£å¼æ’ç¨‹ - è‡ªå‹•æ‰“å¡ 

on:
  # # æ­£å¼æ’ç¨‹æ™‚é–“ï¼ˆæš«æ™‚è¨»è§£ï¼‰
  # schedule:
  #   # é€±ä¸€åˆ°é€±äº” æ—©ä¸Š 8:30 (UTC 00:30) - ç°½åˆ°æ™‚é–“
  #   - cron: '30 0 * * 1-5'
  #   # é€±ä¸€åˆ°é€±äº” ä¸‹åˆ 18:00 (UTC 10:00) - ç°½é€€æ™‚é–“  
  #   - cron: '0 10 * * 1-5'
  
  # å…è¨±æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
    inputs:
      action_type:
        description: 'æ‰“å¡é¡å‹'
        required: true
        default: 'checkin'
        type: choice
        options:
          - checkin    # ç°½åˆ°
          - checkout   # ç°½é€€
      log_level:
        description: 'æ—¥èªŒç­‰ç´š'
        required: false
        default: 'DEBUG'
        type: choice
        options:
          - DEBUG
          - INFO
          - WARN
          - ERROR

jobs:
  production-punch:
    runs-on: ubuntu-latest
    container: ghcr.io/liu-chun-wu/daily-tick-runner/runner:latest  # ä½¿ç”¨è‡ªæœ‰æ˜ åƒ
    timeout-minutes: 15
    
    env:
      BASE_URL: ${{ vars.BASE_URL || 'https://erpline.aoacloud.com.tw/' }}
      COMPANY_CODE: ${{ vars.COMPANY_CODE ||'CYBERBIZ'}}
      AOA_USERNAME: ${{ secrets.AOA_USERNAME }}
      AOA_PASSWORD: ${{ secrets.AOA_PASSWORD }}
      AOA_LAT: ${{ vars.AOA_LAT || '25.080869' }}
      AOA_LON: ${{ vars.AOA_LON || '121.569862' }}
      TZ: ${{ vars.TZ || 'Asia/Taipei' }}
      LOCALE: ${{ vars.LOCALE || 'zh-TW' }}
      DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
      LINE_CHANNEL_ACCESS_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
      LINE_USER_ID: ${{ secrets.LINE_USER_ID }}
      LOG_LEVEL: ${{ github.event.inputs.log_level || 'INFO' }}
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v5

      - name: ğŸ• åˆ¤æ–·åŸ·è¡Œæ™‚æ©Ÿ
        id: determine-action
        run: |
          # å–å¾—å°åŒ—æ™‚é–“
          TAIPEI_HOUR=$(TZ='Asia/Taipei' date '+%H')
          TAIPEI_MINUTE=$(TZ='Asia/Taipei' date '+%M')
          TAIPEI_TIME="${TAIPEI_HOUR}:${TAIPEI_MINUTE}"
          
          echo "å°åŒ—æ™‚é–“: $TAIPEI_TIME"
          
          # æ‰‹å‹•è§¸ç™¼æ™‚ä½¿ç”¨è¼¸å…¥åƒæ•¸
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            ACTION_TYPE="${{ github.event.inputs.action_type }}"
            echo "æ‰‹å‹•è§¸ç™¼ï¼ŒåŸ·è¡Œé¡å‹: $ACTION_TYPE"
          else
            # è‡ªå‹•æ’ç¨‹åˆ¤æ–·
            if [ "$TAIPEI_HOUR" -ge 8 ] && [ "$TAIPEI_HOUR" -le 10 ]; then
              ACTION_TYPE="checkin"
              echo "ä¸Šåˆæ™‚æ®µï¼ŒåŸ·è¡Œç°½åˆ°"
            elif [ "$TAIPEI_HOUR" -ge 17 ] && [ "$TAIPEI_HOUR" -le 19 ]; then
              ACTION_TYPE="checkout"  
              echo "ä¸‹åˆæ™‚æ®µï¼ŒåŸ·è¡Œç°½é€€"
            else
              ACTION_TYPE=""  # é»˜èªä¸åŸ·è¡Œ
              echo "éæ‰“å¡æ™‚é–“ï¼Œä¸åŸ·è¡Œä»»ä½•æ“ä½œ"
            fi
          fi
          
          echo "action_type=$ACTION_TYPE" >> $GITHUB_OUTPUT
          echo "taipei_time=$TAIPEI_TIME" >> $GITHUB_OUTPUT
          echo "should_run=$([[ -n "$ACTION_TYPE" ]] && echo "true" || echo "false")" >> $GITHUB_OUTPUT

      - name: â¹ï¸ æ—©æœŸé€€å‡ºï¼ˆéåŸ·è¡Œæ™‚é–“ï¼‰
        if: steps.determine-action.outputs.should_run != 'true'
        run: |
          echo "â¹ï¸ éæ‰“å¡æ™‚é–“ï¼Œå·¥ä½œæµç¨‹æå‰çµæŸ"
          echo "â° å°åŒ—æ™‚é–“: ${{ steps.determine-action.outputs.taipei_time }}"
          echo "ğŸ’¡ é€™æ¨£å¯ä»¥ç¯€çœ GitHub Actions çš„ä½¿ç”¨æ™‚é–“"
          exit 0

      - name: ğŸ“¦ Setup Node.js
        if: steps.determine-action.outputs.should_run == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ”§ Install dependencies
        if: steps.determine-action.outputs.should_run == 'true'
        run: npm ci

      # Playwright ç€è¦½å™¨å’Œä¸­æ–‡å­—å‹å·²åœ¨å®¹å™¨ä¸­é è£ï¼Œç„¡éœ€å†å®‰è£

      - name: ğŸ” Environment check and login setup
        if: steps.determine-action.outputs.should_run == 'true'
        run: |
          echo "ğŸ” é–‹å§‹ç’°å¢ƒæª¢æŸ¥å’Œç™»å…¥è¨­ç½®..."
          npx playwright test --project=setup --workers=1

      - name: âœ… åŸ·è¡Œç°½åˆ°ï¼ˆå«é‡è©¦æ©Ÿåˆ¶ï¼‰
        if: steps.determine-action.outputs.action_type == 'checkin'
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 15
          max_attempts: 3
          retry_wait_seconds: 60
          retry_on: error
          command: |
            echo "âœ… é–‹å§‹åŸ·è¡Œç°½åˆ°..."
            echo "â° å°åŒ—æ™‚é–“: ${{ steps.determine-action.outputs.taipei_time }}"
            npx playwright test tests/check/checkin.click.spec.ts --project=chromium-click --workers=1 --trace=on

      - name: âŒ åŸ·è¡Œç°½é€€ï¼ˆå«é‡è©¦æ©Ÿåˆ¶ï¼‰
        if: steps.determine-action.outputs.action_type == 'checkout'
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 15
          max_attempts: 3
          retry_wait_seconds: 60
          retry_on: error
          command: |
            echo "âŒ é–‹å§‹åŸ·è¡Œç°½é€€..."
            echo "â° å°åŒ—æ™‚é–“: ${{ steps.determine-action.outputs.taipei_time }}"
            npx playwright test tests/check/checkout.click.spec.ts --project=chromium-click --workers=1 --trace=on

      - name: ğŸ“¤ Upload test results (if failed)
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: production-results-${{ github.run_number }}
          path: |
            test-results/
            playwright-report/
          retention-days: 14

      - name: ğŸš¨ Notify on failure
        if: failure() && steps.determine-action.outputs.should_run == 'true'
        run: |
          if [ -n "$DISCORD_WEBHOOK_URL" ]; then
            curl -H "Content-Type: application/json" \
                 -d "{\"content\":\"ğŸš¨ **æ­£å¼è‡ªå‹•æ‰“å¡å¤±æ•—**\nğŸ“… æ—¥æœŸ: $(TZ='Asia/Taipei' date '+%Y-%m-%d')\nâ° æ™‚é–“: ${{ steps.determine-action.outputs.taipei_time }}\nğŸ¯ åŸ·è¡Œé¡å‹: ${{ steps.determine-action.outputs.action_type }}\nğŸ”— æŸ¥çœ‹è©³æƒ…: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\"}" \
                 "$DISCORD_WEBHOOK_URL" || echo "Discord é€šçŸ¥ç™¼é€å¤±æ•—"
          fi